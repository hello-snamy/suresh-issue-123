<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager - Suresh Issue 123</title>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 20px; background: #f6f8fa; }
    .container { max-width: 600px; margin: 50px auto; text-align: center; }
    .card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .btn { background: #2ea44f; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; }
    .btn:hover { background: #2c974b; }
    .logout-btn { background: #dc3545; margin-bottom: 20px; }
    .hidden { display: none; }
    .repo-info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div id="login-card" class="card">
      <h2>Content Manager</h2>
      <p>Manage content for Suresh Issue 123</p>
      <div class="repo-info">
        <strong>Repository:</strong> hello-snamy/suresh-issue-123
      </div>
      <button class="btn" onclick="login()">Login with GitHub</button>
    </div>
    
    <div id="cms-container" class="hidden">
      <button class="btn logout-btn" onclick="logout()">Logout</button>
      <div id="nc-root"></div>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'http://173.249.49.45:9050';
    const REPO_FULL_NAME = 'hello-snamy/suresh-issue-123';
    
    let githubToken = null;
    let cmsInitialized = false;

    // Wait for DOM to be fully loaded
    function domReady() {
      return new Promise((resolve) => {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', resolve);
        } else {
          resolve();
        }
      });
    }

    async function checkAuth() {
      try {
        console.log('Checking auth status...');
        const response = await fetch(`${BACKEND_URL}/auth/status`, {
          credentials: 'include',
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Auth status:', data);
        
        if (data.authenticated) {
          githubToken = data.token;
          await initializeCMS();
        } else {
          showLogin();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        showLogin();
      }
    }

    function login() {
      console.log('Starting login...');
      window.location.href = `${BACKEND_URL}/auth/github`;
    }

    async function logout() {
      try {
        await fetch(`${BACKEND_URL}/auth/logout`, {
          method: 'POST',
          credentials: 'include',
          mode: 'cors'
        });
        githubToken = null;
        cmsInitialized = false;
        window.location.reload();
      } catch (error) {
        console.error('Logout failed:', error);
      }
    }

    async function initializeCMS() {
      // Make sure DOM is ready before initializing CMS
      await domReady();
      
      if (cmsInitialized) {
        return; // Don't initialize twice
      }

      console.log('Initializing Decap CMS...');
      
      document.getElementById('login-card').classList.add('hidden');
      document.getElementById('cms-container').classList.remove('hidden');

      // Initialize Decap CMS with hardcoded repo
      if (window.CMS) {
        window.CMS.init({
          config: {
            backend: {
              name: 'github',
              repo: REPO_FULL_NAME,
              branch: 'main'
            },
            load_config_file: false,
            media_folder: "images/uploads",
            public_folder: "/images/uploads",
            collections: [
              {
                name: "blog",
                label: "Blog Posts",
                folder: "posts",
                create: true,
                slug: "{{slug}}",
                fields: [
                  { label: "Title", name: "title", widget: "string" },
                  { label: "Publish Date", name: "date", widget: "datetime" },
                  { label: "Body", name: "body", widget: "markdown" }
                ]
              }
            ]
          }
        });

        // Override authentication to use our token
        const gitHubBackend = window.CMS.getBackend('github');
        if (gitHubBackend && gitHubBackend.authenticate) {
          const originalAuthenticate = gitHubBackend.authenticate;
          gitHubBackend.authenticate = function() {
            console.log('Using token for authentication');
            return Promise.resolve({ token: githubToken });
          };
        }

        cmsInitialized = true;
        console.log('Decap CMS initialized successfully');
      } else {
        console.error('Decap CMS not loaded');
      }
    }

    function showLogin() {
      document.getElementById('login-card').classList.remove('hidden');
      document.getElementById('cms-container').classList.add('hidden');
    }

    // Handle auth callback and initialize
    async function init() {
      await domReady();
      
      const urlParams = new URLSearchParams(window.location.search);
      console.log('URL params:', urlParams.toString());
      
      if (urlParams.get('auth') === 'success') {
        console.log('Auth success, checking status...');
        window.history.replaceState({}, document.title, window.location.pathname);
        await checkAuth();
      } else if (urlParams.get('auth') === 'error') {
        console.log('Auth error');
        alert('Authentication failed. Please try again.');
        window.history.replaceState({}, document.title, window.location.pathname);
        showLogin();
      } else {
        console.log('No auth params, checking status...');
        await checkAuth();
      }
    }

    // Start the application
    init().catch(console.error);
  </script>
</body>
</html>
