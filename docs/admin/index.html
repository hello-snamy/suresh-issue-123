<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 20px; background: #f6f8fa; }
    .container { max-width: 600px; margin: 50px auto; text-align: center; }
    .card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .btn { background: #2ea44f; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; }
    .btn:hover { background: #2c974b; }
    .hidden { display: none; }
    .user-info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div id="login-card" class="card">
      <h2>Content Manager</h2>
      <p>Manage content for this site</p>
      <p class="user-info" id="repo-info">Repository: Detecting...</p>
      <button class="btn" onclick="login()">Login with GitHub</button>
    </div>
    
    <div id="cms-container" class="hidden">
      <button class="btn" onclick="logout()" style="background: #dc3545; margin-bottom: 20px;">Logout</button>
      <div id="nc-root"></div>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'http://173.249.49.45:9050';
    let githubToken = null;
    let currentRepo = null;

    // Auto-detect repository from current domain
    function getCurrentRepo() {
      const host = window.location.hostname;
      const accountName = host.replace('.github.io', '');
      return {
        owner: accountName,
        name: `${accountName}.github.io`,
        fullName: `${accountName}/${accountName}.github.io`
      };
    }

    async function checkAuth() {
      try {
        currentRepo = getCurrentRepo();
        document.getElementById('repo-info').textContent = `Repository: ${currentRepo.fullName}`;

        const response = await fetch(`${BACKEND_URL}/auth/status`, {
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.authenticated) {
          githubToken = data.token;
          initializeCMS();
        } else {
          showLogin();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        showLogin();
      }
    }

    function login() {
      window.location.href = `${BACKEND_URL}/auth/github`;
    }

    async function logout() {
      try {
        await fetch(`${BACKEND_URL}/auth/logout`, {
          method: 'POST',
          credentials: 'include'
        });
        githubToken = null;
        window.location.reload();
      } catch (error) {
        console.error('Logout failed:', error);
      }
    }

    function initializeCMS() {
      document.getElementById('login-card').classList.add('hidden');
      document.getElementById('cms-container').classList.remove('hidden');

      // Initialize Decap CMS with the actual GitHub backend
      // using the token we got from our auth proxy
      window.CMS.init({
        config: {
          backend: {
            name: 'github',
            repo: currentRepo.fullName,
            branch: 'main',
            base_url: 'https://api.github.com'
          },
          load_config_file: false,
          media_folder: "images/uploads",
          public_folder: "/images/uploads",
          collections: [
            {
              name: "blog",
              label: "Blog Posts",
              folder: "posts",
              create: true,
              slug: "{{slug}}",
              fields: [
                { label: "Title", name: "title", widget: "string" },
                { label: "Publish Date", name: "date", widget: "datetime" },
                { label: "Body", name: "body", widget: "markdown" }
              ]
            },
            {
              name: "pages",
              label: "Pages",
              folder: "pages", 
              create: true,
              slug: "{{slug}}",
              fields: [
                { label: "Title", name: "title", widget: "string" },
                { label: "Body", name: "body", widget: "markdown" }
              ]
            }
          ]
        }
      });

      // Override Decap CMS authentication to use our token
      const originalAuthenticate = window.CMS.getBackend('github').authenticate;
      window.CMS.getBackend('github').authenticate = function() {
        return Promise.resolve({ token: githubToken });
      };
    }

    function showLogin() {
      document.getElementById('login-card').classList.remove('hidden');
      document.getElementById('cms-container').classList.add('hidden');
    }

    // Handle auth callback
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('auth') === 'success') {
      window.history.replaceState({}, document.title, '/admin/');
      setTimeout(checkAuth, 1000);
    } else if (urlParams.get('auth') === 'error') {
      alert('Authentication failed. Please try again.');
      window.history.replaceState({}, document.title, '/admin/');
    }

    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
</html>
