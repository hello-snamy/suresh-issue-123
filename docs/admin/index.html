<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 20px; background: #f6f8fa; }
    .container { max-width: 600px; margin: 50px auto; text-align: center; }
    .card { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .btn { background: #2ea44f; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; }
    .btn:hover { background: #2c974b; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div id="login-card" class="card">
      <h2>Content Manager</h2>
      <p>Manage content for your site</p>
      <button class="btn" onclick="login()">Login with GitHub</button>
    </div>
    
    <div id="cms-container" class="hidden">
      <div id="nc-root"></div>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'http://173.249.49.45:9050';
    const REPO = 'hello-snamy/suresh-issue-123';
    let githubToken = null;

    // Handle messages from popup
    window.addEventListener('message', function(event) {
      if (event.data === 'authorizing:github') {
        console.log('Authorization in progress...');
      }
      else if (event.data.startsWith('authorization:github:success:')) {
        const data = JSON.parse(event.data.replace('authorization:github:success:', ''));
        githubToken = data.token;
        console.log('Token received:', githubToken);
        initializeCMS();
      }
      else if (event.data === 'authorization:github:error') {
        alert('Authentication failed. Please try again.');
      }
    });

    function login() {
      // Open auth in popup window
      const popup = window.open(
        `${BACKEND_URL}/auth/github`,
        'github-auth',
        'width=600,height=600'
      );
    }

    function initializeCMS() {
      document.getElementById('login-card').classList.add('hidden');
      document.getElementById('cms-container').classList.remove('hidden');

      // Initialize Decap CMS
      window.CMS.init({
        config: {
          backend: {
            name: 'github',
            repo: REPO,
            branch: 'main'
          },
          load_config_file: false,
          media_folder: "images/uploads",
          public_folder: "/images/uploads",
          collections: [
            {
              name: "blog",
              label: "Blog Posts",
              folder: "posts",
              create: true,
              slug: "{{slug}}",
              fields: [
                { label: "Title", name: "title", widget: "string" },
                { label: "Publish Date", name: "date", widget: "datetime" },
                { label: "Body", name: "body", widget: "markdown" }
              ]
            }
          ]
        }
      });

      // Override authentication to use our token
      const gitHubBackend = window.CMS.getBackend('github');
      const originalAuthenticate = gitHubBackend.authenticate;
      
      gitHubBackend.authenticate = function() {
        return Promise.resolve({ token: githubToken });
      };
    }
  </script>
</body>
</html>
